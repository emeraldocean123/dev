# Photo Vault Architecture
**Last Updated:** October 11, 2025
**Status:** Implementation Plan

## Overview

This document describes the photo vault and backup architecture using Mylio Photos, Syncthing, Immich, and Proxmox Backup Server across the homelab infrastructure.

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────┐
│  Alienware Laptop (192.168.1.109)                          │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  D:\Mylio Photos Vault                              │   │
│  │  - Original photos and videos                       │   │
│  │  - Managed by Mylio Photos                          │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓ Syncthing                         │
│                    (continuous sync)                        │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  intel-1250p (192.168.1.40) - Primary NAS                   │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  ZFS Dataset: rpool/media                           │   │
│  │  Mount: /mnt/media                                  │   │
│  │  - Syncthing target                                 │   │
│  │  - Complete photo vault mirror                      │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓ Bind Mount                        │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  Immich LXC (192.168.1.51)                          │   │
│  │  Mount: /mnt/media (read-only bind mount)           │   │
│  │  - Immich External Library (read-only)              │   │
│  │  - Browse/search photos via Immich UI               │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  PBS LXC (192.168.1.52)                             │   │
│  │  - Backs up all LXCs (Docker, Immich)               │   │
│  │  - Backs up rpool/media dataset                     │   │
│  └─────────────────────────────────────────────────────┘   │
│                         ↓ PBS-to-PBS Sync                   │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│  intel-n6005 (192.168.1.41) - Backup Server                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  PBS Instance                                       │   │
│  │  - Replicated LXC backups                           │   │
│  │  - Replicated photo dataset backups                 │   │
│  │  - Full redundancy (ZFS mirror)                     │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

---

## Component Breakdown

### 1. Laptop (Source of Truth)
**Location:** Alienware 18 Area-51 (192.168.1.109)
**Storage:** D:\Mylio Photos Vault

**Role:**
- Primary photo management with Mylio Photos
- Source of truth for all photos
- Syncthing client syncs to intel-1250p

**Software:**
- Mylio Photos (photo management)
- Syncthing (continuous sync)

---

### 2. intel-1250p - Primary NAS (Sync Target)
**Location:** 192.168.1.40
**Storage:** ZFS dataset `rpool/media`

**Role:**
- Receives photos from laptop via Syncthing
- Central photo storage for homelab
- Serves photos to Immich as external library
- PBS backs up this dataset

**Implementation:**
```bash
# Create ZFS dataset for media
zfs create rpool/media
zfs set mountpoint=/mnt/media rpool/media
zfs set compression=lz4 rpool/media  # Efficient for photos/videos
zfs set atime=off rpool/media        # Better performance
```

**Syncthing Configuration:**
- Folder: /mnt/media
- Sync from: Laptop D:\Mylio Photos Vault
- Mode: Receive-only (laptop is source of truth)

---

### 3. Immich LXC (Photo Viewer)
**Location:** 192.168.1.51
**Container:** LXC container on intel-1250p

**Role:**
- Web-based photo browsing/searching
- External library access (read-only)
- Does NOT modify original photos
- ML features (facial recognition, object detection)

**Implementation:**
```bash
# On Proxmox host (intel-1250p)
# Add bind mount to Immich LXC config
# Edit /etc/pve/lxc/<CTID>.conf

mp0: /mnt/media,mp=/mnt/media,ro=1

# Inside Immich LXC:
# Configure Immich external library pointing to /mnt/media
# Set as read-only in Immich settings
```

**Immich Configuration:**
- External Library Path: /mnt/media
- Mode: Read-only (import only, don't move/modify)
- Scan: Manual or scheduled
- Thumbnails: Generated by Immich (stored separately)

---

### 4. PBS Backups (intel-1250p)
**Location:** 192.168.1.52 (LXC on intel-1250p)

**Backup Jobs:**

#### Job 1: LXC Backups (Native PBS)
```
Target: All LXCs (Docker, Immich)
Schedule: Daily at 2 AM
Retention: 7 daily, 4 weekly, 6 monthly
```

#### Job 2: Media Dataset Backup (proxmox-backup-client)
```bash
# Run from intel-1250p host
proxmox-backup-client backup \
  media.pxar:/mnt/media \
  --repository root@pam@192.168.1.52:datastore \
  --schedule daily

# Or create a systemd timer for automated backups
```

**Benefits:**
- Deduplication (only new/changed photos backed up)
- Compression (efficient storage)
- Point-in-time snapshots (restore any date)
- Efficient PBS-to-PBS sync to n6005

---

### 5. intel-n6005 - Backup Server (Final Destination)
**Location:** 192.168.1.41
**Storage:** ZFS mirror (2×4TB)

**Role:**
- Receives PBS-to-PBS sync from intel-1250p
- Long-term backup retention
- Disaster recovery source
- Redundant storage (survives drive failure)

**PBS Configuration:**
- Install PBS on n6005 (LXC or direct)
- Configure as remote on intel-1250p PBS
- Create sync jobs (1250p → n6005)
- Retention: Longer than primary (30+ days)

---

## Data Flow Summary

### Normal Operation (Photo Added to Laptop)
1. Add photo to D:\Mylio Photos Vault on laptop
2. Syncthing detects change
3. Photo syncs to intel-1250p `/mnt/media`
4. Immich can scan and index new photo (read-only)
5. PBS backs up `/mnt/media` (incremental)
6. PBS-to-PBS syncs backup to n6005

**Timeline:**
- Syncthing: Near real-time (seconds to minutes)
- Immich scan: Manual or scheduled
- PBS backup: Daily (scheduled)
- PBS-to-PBS sync: After backup completes

---

## Advantages of This Architecture

### 1. Single Source of Truth
- ✓ Laptop D: drive is authoritative
- ✓ Mylio manages photos (no conflicts)
- ✓ Syncthing propagates changes automatically

### 2. Read-Only Immich
- ✓ Prevents accidental photo modification
- ✓ Immich can't delete originals
- ✓ Safe to experiment with Immich features
- ✓ Thumbnails/metadata stored separately

### 3. Efficient Backups
- ✓ PBS deduplication (don't backup same photo twice)
- ✓ Incremental forever (only changed data)
- ✓ Point-in-time recovery (restore any snapshot)
- ✓ ZFS snapshots on rpool/media (instant rollback)

### 4. Redundancy Layers
- ✓ Layer 1: Laptop D: drive (original)
- ✓ Layer 2: intel-1250p /mnt/media (synced copy)
- ✓ Layer 3: PBS backup on intel-1250p
- ✓ Layer 4: PBS replicated to n6005 (mirrored drives)

### 5. Flexibility
- ✓ Access photos via Mylio (on laptop)
- ✓ Access photos via Immich (web browser)
- ✓ Direct file access (SMB/NFS if needed)
- ✓ Restore from any PBS snapshot

---

## Storage Capacity Planning

### Photo Vault Size Estimation
Assuming:
- Current photos: ~200GB (example)
- Annual growth: ~50GB/year
- 5 years: ~450GB

### Storage Allocation
| Location | Capacity | Usage | Purpose |
|----------|----------|-------|---------|
| Laptop D: | Varies | Live vault | Working copy |
| intel-1250p rpool/media | 3.62TB | ~500GB | Synced mirror |
| PBS primary backups | 3.62TB | ~100GB | Deduplicated snapshots |
| n6005 PBS backups | 3.62TB | ~100GB | Replicated backups |

**Notes:**
- PBS deduplication dramatically reduces backup size
- ZFS compression saves additional space
- Both hosts have plenty of room for growth

---

## Implementation Steps

### Step 1: Create ZFS Dataset on intel-1250p
```bash
ssh intel-1250p
zfs create rpool/media
zfs set mountpoint=/mnt/media rpool/media
zfs set compression=lz4 rpool/media
zfs set atime=off rpool/media
mkdir -p /mnt/media
chmod 755 /mnt/media
```

### Step 2: Configure Syncthing on Laptop
```
1. Install Syncthing (if not already)
2. Add folder: D:\Mylio Photos Vault
3. Set folder type: "Send Only"
4. Add device: intel-1250p
5. Set sync path on intel-1250p: /mnt/media
```

### Step 3: Configure Syncthing on intel-1250p
```bash
# Install Syncthing on intel-1250p (if not already)
# Option 1: Docker container
# Option 2: Native Debian package
# Option 3: LXC container

# Add laptop as device
# Accept shared folder
# Set folder path: /mnt/media
# Set folder type: "Receive Only"
```

### Step 4: Add Bind Mount to Immich LXC
```bash
# On intel-1250p host
pct stop 51  # Stop Immich LXC

# Edit LXC config
nano /etc/pve/lxc/51.conf

# Add line:
mp0: /mnt/media,mp=/mnt/media,ro=1

# Start LXC
pct start 51

# Verify inside Immich LXC
pct enter 51
ls -lh /mnt/media
```

### Step 5: Configure Immich External Library
```
1. Login to Immich web UI (https://192.168.1.51:2283)
2. Go to Administration → Libraries
3. Add External Library
4. Path: /mnt/media
5. Enable: Read-only (import only)
6. Scan library
```

### Step 6: Set Up PBS Media Backup
```bash
# Create PBS backup job for media dataset
# Option 1: Use proxmox-backup-client directly
# Option 2: Create systemd timer
# Option 3: Add to PBS GUI (if possible)

# Example backup command:
proxmox-backup-client backup \
  media.pxar:/mnt/media \
  --repository root@pam@192.168.1.52:datastore
```

### Step 7: Configure PBS-to-PBS Sync
```
1. Install PBS on intel-n6005 (port 8007)
2. On intel-1250p PBS web UI:
   - Add remote: intel-n6005
   - Create sync job
   - Schedule: After backups complete
3. Verify sync runs successfully
```

---

## Maintenance Tasks

### Daily (Automated)
- Syncthing syncs laptop → intel-1250p
- PBS backs up LXCs and photos
- PBS-to-PBS sync replicates to n6005

### Weekly (Manual/Automated)
- Immich library scan (if not automatic)
- Verify Syncthing sync status
- Check PBS backup job success

### Monthly
- ZFS scrub on both intel-1250p and n6005
- Review PBS storage usage
- Test restore from PBS backup

---

## Disaster Recovery Scenarios

### Scenario 1: Laptop Drive Failure
**Impact:** Loss of working photo vault

**Recovery:**
1. Replace laptop drive
2. Restore from intel-1250p /mnt/media
3. Syncthing will sync back to laptop
4. Mylio Photos rebuilds database

**Downtime:** 0 hours (photos available on Immich)
**Recovery Time:** Hours (depending on photo vault size)

---

### Scenario 2: intel-1250p Failure
**Impact:** Loss of primary NAS and Immich

**Recovery:**
1. Replace/reinstall intel-1250p
2. Restore PBS backup from n6005
3. Re-create ZFS dataset and LXCs
4. Reconfigure Syncthing
5. Photos resume syncing from laptop

**Downtime:** 2-4 hours
**Data Loss:** None (laptop has originals, n6005 has backups)

---

### Scenario 3: Both intel-1250p AND Laptop Failure
**Impact:** Loss of primary copies

**Recovery:**
1. Restore photos from n6005 PBS backup
2. Extract from PBS snapshot
3. Rebuild systems

**Downtime:** 4-8 hours
**Data Loss:** Photos taken since last PBS backup (max 24 hours)

---

## Security Considerations

### Read-Only Immich
- Prevents accidental deletion via Immich UI
- Photos can only be modified on laptop (Mylio)
- Immich can't move/rename originals

### Syncthing Encryption
- Syncthing uses TLS for transfer
- Consider enabling device authentication
- Use strong device passwords

### PBS Encryption
- Optional: Encrypt PBS backups
- Protects data at rest on backup server
- Required for offsite backups

---

## Future Enhancements

### Near-Term
1. Install Syncthing on intel-1250p
2. Create ZFS dataset for photos
3. Configure Immich external library

### Medium-Term
1. Automate PBS photo backups
2. Set up monitoring for Syncthing sync status
3. Configure PBS retention policies

### Long-Term
1. Add offsite backup (cloud or external drive)
2. Implement automated testing of restores
3. Consider Immich machine learning features

---

## Quick Reference

### Key Paths
- Laptop: `D:\Mylio Photos Vault`
- intel-1250p: `/mnt/media` (ZFS: rpool/media)
- Immich LXC: `/mnt/media` (read-only bind mount)
- PBS backups: Stored in PBS datastore

### Key Services
- Syncthing (laptop): Port 8384
- Syncthing (intel-1250p): Port 8384
- Immich: https://192.168.1.51:2283
- PBS: https://192.168.1.52:8007

### SSH Access
```bash
ssh intel-1250p    # Primary NAS
ssh immich         # Immich LXC (via SSH alias)
ssh pbs-1250p      # PBS LXC on intel-1250p
ssh pbs-n6005      # PBS LXC on intel-n6005
ssh intel-n6005    # Backup server
```

---

## Notes

- Mylio Photos remains the source of truth for photo management
- Syncthing provides automatic, continuous synchronization
- Immich provides web-based viewing without modifying originals
- PBS provides efficient, deduplicated backups
- n6005 provides redundant backup storage with drive failure protection
- This architecture follows the 3-2-1 backup rule:
  - 3 copies (laptop, intel-1250p, n6005)
  - 2 different storage types (laptop SSD, server NVMe)
  - 1 offsite (consider cloud backup for critical photos)
